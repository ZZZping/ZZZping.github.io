---
layout: post
title: SQL笔记
date: 2020-03-30 08:28:24.000000000 +09:00
---

## 数据库和SQL

## 擦寻基础

## 聚合与排序

### 对表进行聚合查询

   + COUNT:计算表中的行数
      1. 计算表中数据的行数

      ```SQL
         SELECT COUNT(*)
         FROM Product;
      ```

      2. 计算NULL之外数据行数
         + 

         ```SQL
            --计算purchase_prise中非空行个数
            SEELECT COUNT(pruchase_prise)
            FROM Product;
         ```

         + 

         ```SQL
            --一张表中只含有NULL参数时，COUNT(*)和COUNT(col_1)的结果不一样，第一个结果为3，第二个结果为0
            SELECT COUNT(*), COUNT(col_1)
            FROM NullTab1;
         ```

   + SUM:计算表中数值列中数据的合计值
      1. 计算合计值
         + 

         ```SQL
            --计算销售单价的合计值
            SELECT SUM(sale_price)
            FROM Product;
         ```

         + 

         ```SQL
            --计算表中两列的合计值
            SELECT SUM(sale_price), SUM(purchase_price)
            FROM Product;
         ```

   + AVG:计算表中数值列中数据的平均值
      + 计算平均值

      ```SQL
         SELECT AVG(sale_price)
         FROM Product;
      ```

      + 

      ```SQL
         --计算含有NULL的平均值
         SELECT AVG(sale_price), AVG(purchase_price)
         FROM Product;
      ```

         + 当含有NULL值时，会先将NULL删除，在计算平均值，分母也会相应的减少NULL的数量
   + MAX:计算表中任意列中数据的最大值
      + 

      ```SQL
         --计算最大值
         SELECT MAX(sale_price)
         FROM Product;
      ```

   + MIN:计算表中任意列中数据的最小值
      + 

      ```SQL
         --计算最小值
         SELECT MIN(purchase_price)
         FROM Product;
      ```

   + 使用聚合函数删除重复值（DISTINCT关键字）
      + 

      ```SQL
         SELECT COUNT(DISTINCT product_type)
         FROM Product;
      ```

      + DISTINCT删除product_type中的重复数据
   + 聚合函数会将NULL排除在外，但COUNT(*)例外，不会排除NULL
   + MAX/MIN与SUM/AVG函数不同，MAX/MIN函数适用于任何数据类型，SUM/AVG函数只能对数值类型列使用
   + 所有的聚合函数都可以使用DISTINCT关键字

### 对表进行分组

   + GROUP BY语句
      1. 

      ```SQL
         --按照商品种类统计数据行数
         SELECT product_type, COUNT(*)
         FROM PRODUCT
         GROUP BY product_type;
      ```

      2. 使用WHERE时使用GROUP BY

      ```SQL
         SELECT purchase_price, COUNT(*)
         FROM Product
         WHERE product_type = '衣服'
         GROUP BY purchase_price;
      ```

### 对聚合结果指定条件

   + HAVING语句
      + WHERE语句只能用来指定记录的条件，不能用来指定组的条件
         + WHERE子句 = 指定行对应的条件
      + HAVING语句可以用来对集合指定条件
         + HAVING子句 = 指定组对应的条件
   + HAVING语句要写在GROUP BY之后，在DBMS中的执行顺序也在GROUP BY之后
      + 

      ```SQL
         --从按照商品种类进行分组后的结果中，取出“包含数据行数为2行”的组
         SELECT product_type, COUNT(*)
         FROM Product
         GROUP BY product_type
         HAVING COUNT(*) = 2;
      ```

      + 执行结果
      ![avatar](/assets/images/使用HAVING.png)
      <br>
      + 

      ```SQL
         --不使用HAVING语句
         SELECT product_type, COUNT(*)
         FROM Product
         GROUP BY product;
      ```

      + 执行结果
      ![avatar](/assets/images/不使用HAVING.png)
      <br>
   + HAVING子句的构成要素
      1. 常数
      2. 聚合函数
      3. GROUP BY子句中指定的列名（即聚合键）

### 对查询结果进行安排

   + ORDER BY语句
      + 在SELECT语句末尾添加ORDER BY语句可以指定排序的顺序
      + 

      ```SQL
         --按照销售单价由低到高排序
         SELECT product_id, product_name, sale_price, purchase_prise
         FROM Product
         ORDER BY sale_price;
      ```

      + 执行结果
      ![avatar](/assets/images/ORDER_BY_1.png)<br>
   + ORDER BY语句要写在SELECT语句末尾，因为对数据行进行排序的操作必须在结果即将返回时执行
   + 降序是在ORDER BY语句后加上DESC关键字
   + 

   ```SQL
      --按照销售单价由低到高排序
      SELECT product_id, product_name, sale_price, purchase_prise
      FROM Product
      ORDER BY sale_price DESC;
   ```

   + 执行结果
   ![avatar](/assets/images/ORDER_BY_DESC.png)<br>
   + 使用升序排序时在ORDER BY末尾应该添加ASC关键字，但默认排序为升序
   + 指定多个排序键
      + 

      ```SQL
         --按照销售单价和商品编号的升序进行排序
         SELECT product_id, product_name, sale_price, purchase_prise
         FROM Product
         ORDER BY sale_price, product_id;
      ```

      + 执行结果
      ![avatar](/assets/images/ORDER_BY_MANY.png)<br>
   + NULL的顺序

   ```SQL
      --按照进货单价的升序进行排序
      SELECT product_id, product_name, sale_price, purchase_prise
      FROM Product
      ORDER BY purchase_price;
   ```

   + 执行结果
   ![avatar](/assets/images/ORDER_BY_NULL.png)<br>
      + 排序键中包含NULL时，会在开头或末尾进行汇总
   + 在排序键中使用显示用的别名
      + 在ORDER BY语句中可以使用别名，因为SQL语句在DBMS内部的执行顺序被掩盖起来，SELECT子句的执行顺序在GROUP BY子句之后，在ORDER BY子句之前
      + 

      ```SQL
         --ORDER BY中使用列的别名
         SELECT product_id AS id, product_name, sale_price AS sp, purchase_price
         FROM Product
         ORDER BY sp, id;
      ```

      + 执行结果
      ![avatar](/assets/images/ORDER_BY_AS.png)<br>

## 数据更新

### 数据插入

### 数据删除

### 数据的更新

### 事务

## 复杂查询

### 视图

### 子查询

   1. 子查询和视图
      1. 子查询就是将用来定义视图的select语句直接用于FROM子句中

      ```SQL
         --创建视图
         CREATE VIEW ProductSum(product_type, cnt_product)
         AS
         SELECT product_type, COUNT(*)
            FROM Product
         GROUP BY product_type;

         --确认创建好的视图
         SELECT product_type, cnt_product
            FROM ProductSum;
      ```

      ```SQL
         --在FROM语句中直接书写定义select查询
         SELECT product_type, cnt_product
            FROM (SELECT product_type, COUNT(*)
                     FROM Product
                  GROUP BY product_type) AS ProductSum;
         --先执行FROM子句中包含的SELECT语句,再执行外层的SELECT语句
      ```

      + 上面两个SQL语句的执行结果
      ![avatar](/assets/images/子查询和视图1.png)<br>

      + **子查询作为内层查询会被先执行**

      + 增加子查询的嵌套层数

      ```SQL
         SELECT prosuct_type, cnt_product
            FROM (SELECT *
                     FROM (SELECT product_type, COUNT(*) AS cnt_product
                              FROM Product
                           GROUP BY product_type) AS ProductSum
                     WHERE cnt_product = 4) AS ProductSum2;
      ```

      + 执行结果
      ![avatar](/assets/images/增加子查询的嵌套.png)<br>

   2. 子查询的名称
      + 原则上子查询必须设定名称

   3. 标量子查询
      + 标量就是单一的意思
      + 标量子查询只能返回一行一列的结果

      ```SQL
         --WHERE子句中不能使用聚合函数
         SELECT product_id, product_name, sale_price
            FROM Product
         WHERE sale_price > AVG(sale_price);
         --错误:WHERE子句中不可以使用聚合函数
      ```

      ```SQL
         SELECT product_id, product_name, sale_price
            FROM Product
         WHERE sale_price > (SELECT AVG(sale_price)
                              FROM Product);
         --SELECT AVG...为计算平均销售单价的标量子查询
      ```

      + 执行结果
      ![avatar](/assets/images/标量子查询1.png)<br>

      + 上面的SQL语句在执行时先执行SELECT AVG..部分,再将执行得到的平均值代入到WHERE子句中

   4. 标量子查询的书写位置

      + 可以使用常数或者列名的地方,无论是SELECT子句,GROUP BY子句,HAVING子句,还是ORDER子句,都可以使用标量子查询

   5. 使用标量子查询的注意事项

      + 标量子查询只能返回单行结果,不能返回多行结果

### 关联子查询

## 函数、谓词、case表达式

## 集合运算

## SQL高级处理

## 通过应用程序链接数据库
